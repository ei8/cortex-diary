@using ei8.Cortex.Diary.Domain.Model
@using ei8.Cortex.Diary.Application.Settings
@using ei8.Cortex.Diary.Application
@using ei8.Cortex.Diary.Port.Adapter.UI.Views.Blazor.ViewModels

@inject ITokenProvider tokenProvider
@inject IEnumerable<View> views
@inject NavigationManager navigationManager
@inject IToastService toastService
@inject ISettingsService settingsService

<Bar Background="Background.Dark" ThemeContrast="ThemeContrast.Dark"
     Mode="@(this.NavBarType == NavBarType.Side ? BarMode.VerticalInline : BarMode.Horizontal)" CollapseMode="BarCollapseMode.Small"
     Visible="@(this.NavBarType == NavBarType.Side)">
    <BarBrand>
        <BarItem>
            <BarLink To="">
                <BarIcon IconName="brandLogo" />
                neurUL &lt;#
            </BarLink>
        </BarItem>
    </BarBrand>
    <BarToggler />
    <BarMenu Class="@(this.NavBarType == NavBarType.Top ? "m-2" : string.Empty)">
        <BarStart>
            @foreach (var v1 in this.views.Where(vi => string.IsNullOrWhiteSpace(vi.ParentUrl)))
            {
                <BarItem Class=@(this.GetBarActiveClassValue(v1))>
                    @if (this.views.Any(vi => vi.ParentUrl == v1.Url))
                    {
                        <BarDropdown Visible=@(this.views.Any(vi => vi.ParentUrl == v1.Url && vi.Url == this.navigationManager.Uri))>
                            <BarDropdownToggle>
                                <BarIcon IconName="MainMenu(v1.Icon)" />
                                @v1.Name
                            </BarDropdownToggle>
                            @if (this.views.Any(vi => vi.Url == this.navigationManager.Uri && vi.ParentUrl == v1.Url))
                            {
                        <BarDropdownMenu id="data-visible" Class="data-visibility">
                            @foreach (var v2 in this.views.Where(vi => vi.ParentUrl == v1.Url))
                            {
                                if (v2.Url == this.navigationManager.Uri)
                                {
                                    <BarDropdownItem Class="bar-active havor" Clicked="() => this.Navigate(v2.Url)">
                                        <BarIcon IconName="MainMenu(v2.Icon)" />
                                        @v2.Name
                                    </BarDropdownItem>
                                }
                                else
                                {
                                    <BarDropdownItem Class=@(this.GetBarActiveClassValue(v2)) Clicked="() => this.Navigate(v2.Url)">
                                        <BarIcon IconName="MainMenu(v2.Icon)" />
                                        @v2.Name
                                    </BarDropdownItem>
                                }
                            }
                        </BarDropdownMenu>
                            }
                            else
                            {
                                <BarDropdownMenu id="data-visible">
                                    @foreach (var v2 in this.views.Where(vi => vi.ParentUrl == v1.Url))
                                    {
                                        <BarDropdownItem Class="havor" Clicked="() => this.Navigate(v2.Url)">
                                            <BarIcon IconName="MainMenu(v2.Icon)" />
                                            @v2.Name
                                        </BarDropdownItem>
                                    }
                                </BarDropdownMenu>
                            }
                        </BarDropdown>
                        }
                        else
                        {
                            <BarLink Clicked="() => this.Navigate(v1.Url)">
                                <BarIcon IconName="MainMenu(v1.Icon)" />
                                @v1.Name
                            </BarLink>
                        }
                    </BarItem>
                }
        </BarStart>
        <BarEnd>
            <BarItem>
                <AuthorizeView>
                    <NotAuthorized />
                    <Authorized>
                        <BarDropdown>
                            <BarDropdownToggle>
                                <BarIcon IconName="IconName.Wrench" />
                                Settings
                            </BarDropdownToggle>
                            <BarDropdownMenu>
                                <BarDropdownItem To="#">
                                    Profile
                                </BarDropdownItem>
                                <BarDropdownItem To="#">
                                    Privacy
                                </BarDropdownItem>
                                <BarDropdownItem To="#">
                                    Appearance
                                </BarDropdownItem>
                            </BarDropdownMenu>
                        </BarDropdown>
                    </Authorized>
                </AuthorizeView>
            </BarItem>
            <BarItem>
                <AuthorizeView>
                    <NotAuthorized>
                        <BarLink To="@(this.settingsService.BasePath + "/loginidp")">
                            <BarIcon IconName="signIn" />
                            Sign in
                        </BarLink>
                    </NotAuthorized>
                    <Authorized>
                        <form action=@(this.settingsService.BasePath + "/logoutidp") method="post" id="ff">
                            <BarLink href="#" onclick="frmsubmit('ff');">
                                <BarIcon IconName="signOut" />
                                @context.User.Identity.Name.Truncate(15)
                                <span style="padding-left: 5px; font-size: smaller; font-style: italic">(Sign out)</span>
                            </BarLink>
                            <input name="__RequestVerificationToken" type="hidden" value="@this.tokenProvider.XsrfToken">
                        </form>
                    </Authorized>
                </AuthorizeView>
            </BarItem>
        </BarEnd>
    </BarMenu>
</Bar>

@code {
    private void Navigate(string url)
    {
        this.navigationManager.NavigateTo(url, true);
    }

    private RenderFragment MainMenu(string iconName)
    {
        RenderFragment retFragment = null;
        retFragment = @<span class="oi @iconName" aria-hidden="true"></span>;
        return retFragment;
    }

    private string GetBarActiveClassValue(View value) => 
        value.Url == this.navigationManager.Uri ? "bar-active havor" : string.Empty;

    [Parameter]
    public NavBarType NavBarType { get; set; }

    RenderFragment brandLogo =
    @<img src="dasz.ico" alt="Home" style="width:30px; height:30px">;
    RenderFragment signIn =@<span class="oi oi-account-login" aria-hidden="true"></span>;
    RenderFragment signOut =@<span class="oi oi-account-logout" aria-hidden="true"></span>;
}
